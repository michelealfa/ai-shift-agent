services:
  # 1. API Web Service
  - type: web
    name: shift-agent-api
    env: docker
    dockerContext: .
    dockerfilePath: docker/Dockerfile.api
    plan: free # Cambia in 'starter' se necessario
    region: frankfurt
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: shift-agent-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: shift-agent-redis
          property: connectionString
      - fromGroup: shift-agent-secrets

  # 2. Celery Worker (Background Worker)
  - type: worker
    name: shift-agent-worker
    env: docker
    dockerContext: .
    dockerfilePath: docker/Dockerfile.worker
    region: frankfurt
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: shift-agent-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          type: redis
          name: shift-agent-redis
          property: connectionString
      - fromGroup: shift-agent-secrets

# 3. Managed Databases
databases:
  - name: shift-agent-db
    region: frankfurt
    plan: free

# 4. Managed Redis
redis:
  - name: shift-agent-redis
    region: frankfurt
    plan: free
    ipAllowList: [] # Solo accesso interno

# 5. Shared Secrets Group
envVarGroups:
  - name: shift-agent-secrets
    envVars:
      - key: GEMINI_API_KEY
        sync: false
      - key: TELEGRAM_BOT_TOKEN
        sync: false
      - key: TELEGRAM_WEBHOOK_URL
        sync: false
      - key: GOOGLE_MAPS_API_KEY
        sync: false
      - key: X_API_KEY
        sync: false
      - key: TARGET_USER_NAME
        value: CARLO
